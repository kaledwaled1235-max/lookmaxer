<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Face Analyzer - ثيم أبيض/أسود</title>
  <style>
    :root{--bg:#0b0b0c;--card:#111114;--accent:#ffffff;--muted:#9aa0a6}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial;direction:rtl}
    body{background:linear-gradient(180deg,var(--bg),#050506);color:var(--accent);display:flex;align-items:flex-start;justify-content:center;padding:20px}
    .app{width:100%;max-width:980px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
    .row{display:flex;gap:12px}
    #video{width:320px;height:240px;border-radius:10px;background:#000;object-fit:cover}
    .btn{background:transparent;border:1px solid var(--muted);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#000;border:0}
    .result{margin-top:12px;display:flex;gap:12px;align-items:flex-start}
    .sidebar{width:320px}
    .metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .metric{background:#0c0c0d;padding:8px;border-radius:8px;text-align:center}
    .metric b{display:block;font-size:18px}
    .recommend{margin-top:8px}
    textarea{width:100%;height:80px;background:#070708;border:1px solid #1a1a1b;color:var(--accent);padding:8px;border-radius:8px}
    .footer{margin-top:14px;color:var(--muted);font-size:13px}
    canvas{background:transparent}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="flex:1">
        <h1>Face Analyzer — ثيم أبيض/أسود</h1>
        <div style="color:var(--muted);font-size:13px">يحلل ملامح الوجه ويطلع score + توصيات بسيطة لتحسين المظهر</div>
      </div>
      <div class="controls">
        <button id="startCam" class="btn">شغل الكاميرا</button>
        <button id="stopCam" class="btn">وقف الكاميرا</button>
        <label class="btn"><input id="uploadInput" type="file" accept="image/*" style="display:none"> ارفع صورة</label>
        <button id="analyzeBtn" class="btn primary">حلل الصورة</button>
      </div>
    </header>

    <div class="row">
      <div class="card sidebar">
        <video id="video" autoplay muted></video>
        <canvas id="overlay" width="320" height="240" style="position:relative;top:-240px;left:0"></canvas>
        <div class="metrics" id="metrics">
          <div class="metric"><small>التناسق</small><b id="sym">--</b></div>
          <div class="metric"><small>حدة الفك</small><b id="jaw">--</b></div>
          <div class="metric"><small>بروز الذقن</small><b id="chin">--</b></div>
          <div class="metric"><small>شكل الأنف</small><b id="nose">--</b></div>
          <div class="metric"><small>العيون</small><b id="eyes">--</b></div>
          <div class="metric"><small>البشرة</small><b id="skin">--</b></div>
        </div>
        <div class="footer">مهم: النتيجة تقريبية وتعتمد على جودة الصورة وزاوية التصوير.</div>
      </div>

      <div style="flex:1" class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <div style="font-size:14px;color:var(--muted)">النتيجة الكلية</div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="font-size:36px;font-weight:700" id="score">--</div>
              <div style="color:var(--muted)" id="tier">--</div>
            </div>
          </div>
          <div style="width:220px"><canvas id="radar" width="220" height="220"></canvas></div>
        </div>

        <div class="recommend">
          <h3 style="margin:8px 0">التوصيات</h3>
          <div id="recs">مفيش تحليل لسه</div>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin:8px 0">سجل التحاليل (محلي)</h3>
          <div id="history"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mediapipe and utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Simple single-file face analyzer using MediaPipe FaceMesh
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const startCam = document.getElementById('startCam');
    const stopCam = document.getElementById('stopCam');
    const uploadInput = document.getElementById('uploadInput');
    const analyzeBtn = document.getElementById('analyzeBtn');

    let camera = null;
    let lastResults = null;
    let radarChart = null;

    // helper: normalize value to 0..100
    function clamp01(v){return Math.max(0,Math.min(1,v))}
    function to100(v){return Math.round(clamp01(v)*100)}

    // Basic paired indices for rough symmetry check (MediaPipe indices)
    const pairs = [
      [33,263], // eyes outer
      [133,362], // eyes inner
      [61,291], // mouth corners
      [199,429], // cheek-ish
      [1,  1] // nose center (no pair)
    ];

    function computeMetrics(landmarks){
      // landmarks: array of {x,y,z} normalized
      const N = landmarks.length;
      if(!N) return null;
      // face center (average)
      let cx=0, cy=0;
      for(let p of landmarks){cx+=p.x; cy+=p.y}
      cx/=N; cy/=N;

      // symmetry: average relative distance between pairs
      let symSum=0, symCount=0;
      for(let pr of pairs){
        if(pr.length<2) continue;
        const a=landmarks[pr[0]]; const b=landmarks[pr[1]];
        if(!a||!b) continue;
        const da = Math.hypot(a.x-cx,a.y-cy);
        const db = Math.hypot(b.x-cx,b.y-cy);
        symSum += 1 - Math.abs(da-db)/Math.max(da,db,1e-6);
        symCount++;
      }
      const symmetry = symCount? symSum/symCount : 0.5;

      // jaw sharpness: measure angle at chin between two jaw points
      // using indices: left jaw 234, chin 152, right jaw 454
      const li = landmarks[234], chin = landmarks[152], ri = landmarks[454];
      let jawSharp = 0.5;
      if(li && chin && ri){
        const v1 = {x:li.x-chin.x,y:li.y-chin.y};
        const v2 = {x:ri.x-chin.x,y:ri.y-chin.y};
        const dot = v1.x*v2.x + v1.y*v2.y;
        const mag = Math.hypot(v1.x,v1.y)*Math.hypot(v2.x,v2.y)+1e-6;
        const ang = Math.acos(clamp01(dot/mag)); // in radians
        // smaller angle -> sharper jaw -> higher score
        jawSharp = 1 - ((ang - 0.6)/(1.6-0.6));
      }

      // chin projection: how far chin x is from face center (positive = forward relative)
      let chinProj = 0.5;
      if(chin){
        const faceMidX = cx;
        chinProj = 1 - Math.abs(chin.x - faceMidX)*2; // approximate
      }

      // nose profile: we can't do 3D from single frontal; use nose length ratio
      const noseTop = landmarks[1]; const mouthTop = landmarks[13];
      let noseScore = 0.6;
      if(noseTop && mouthTop){
        const len = Math.abs(noseTop.y - mouthTop.y);
        // normalize by face height
        const top = landmarks[10] ? Math.abs(landmarks[10].y - mouthTop.y) : 0.5;
        const ratio = len/(top||0.5);
        noseScore = 1 - clamp01(Math.abs(ratio - 0.18)*4); // heuristic
      }

      // eyes proportion: distance between eyes vs face width
      let eyesScore = 0.6;
      const le = landmarks[33], re = landmarks[263];
      if(le && re){
        const eyeDist = Math.hypot(le.x-re.x, le.y-re.y);
        const cheekL = landmarks[234], cheekR = landmarks[454];
        if(cheekL && cheekR){
          const faceW = Math.hypot(cheekL.x-cheekR.x, cheekL.y-cheekR.y);
          const ratio = eyeDist/faceW;
          eyesScore = 1 - Math.abs(ratio - 0.27)*3; // heuristic
        }
      }

      // skin quality: basic contrast + smoothness on bounding box area (approx)
      let skinScore = 0.7;
      try{
        // sample small patch around nose area from video frame
        const w = overlay.width, h = overlay.height;
        if(lastImageData){
          // pick box around nose
          const nx = Math.round((noseTop.x||cx)*w), ny = Math.round((noseTop.y||cy)*h);
          const box = 18;
          const img = lastImageData.data;
          let mean=0,varsum=0,cnt=0;
          for(let yy=Math.max(0,ny-box);yy<Math.min(h,ny+box);yy++){
            for(let xx=Math.max(0,nx-box);xx<Math.min(w,nx+box);xx++){
              const idx = (yy*w + xx)*4;
              const r=img[idx], g=img[idx+1], b=img[idx+2];
              const lum = 0.299*r+0.587*g+0.114*b;
              mean += lum; cnt++;
            }
          }
          mean /= Math.max(1,cnt);
          // compute variance
          for(let yy=Math.max(0,ny-box);yy<Math.min(h,ny+box);yy++){
            for(let xx=Math.max(0,nx-box);xx<Math.min(w,nx+box);xx++){
              const idx = (yy*w + xx)*4;
              const r=img[idx], g=img[idx+1], b=img[idx+2];
              const lum = 0.299*r+0.587*g+0.114*b;
              varsum += (lum-mean)*(lum-mean);
            }
          }
          const variance = varsum/Math.max(1,cnt);
          // less variance (smoother) -> higher skin score (heuristic)
          skinScore = clamp01(1 - Math.min(2000,variance)/2000);
        }
      }catch(e){/*ignore*/}

      return {
        symmetry: symmetry,
        jaw: clamp01(jawSharp),
        chin: clamp01(chinProj),
        nose: clamp01(noseScore),
        eyes: clamp01(eyesScore),
        skin: clamp01(skinScore)
      };
    }

    function aggregateScore(m){
      // weights tuned to lookmax-ish preferences
      const w = {symmetry:0.25,jaw:0.25,chin:0.12,nose:0.12,eyes:0.16,skin:0.1};
      let total=0; let sumW=0;
      for(let k in w){ total += (m[k]||0)*w[k]; sumW += w[k]; }
      const final = total/sumW;
      return final;
    }

    function updateUI(metrics){
      if(!metrics) return;
      document.getElementById('sym').innerText = to100(metrics.symmetry);
      document.getElementById('jaw').innerText = to100(metrics.jaw);
      document.getElementById('chin').innerText = to100(metrics.chin);
      document.getElementById('nose').innerText = to100(metrics.nose);
      document.getElementById('eyes').innerText = to100(metrics.eyes);
      document.getElementById('skin').innerText = to100(metrics.skin);

      const sc = aggregateScore(metrics);
      const score10 = Math.round(sc*10*10)/10; // one decimal
      document.getElementById('score').innerText = score10 + ' / 10';
      const tierEl = document.getElementById('tier');
      let tier = 'sub-5';
      if(score10 < 3) tier='sub-3';
      else if(score10 < 5) tier='sub-5';
      else if(score10 < 6.5) tier='5-6';
      else if(score10 < 8) tier='7-8';
      else tier='9-10';
      tierEl.innerText = tier;

      // radar chart
      const labels = ['التناسق','الفك','الذقن','الأنف','العيون','البشرة'];
      const data = [metrics.symmetry,metrics.jaw,metrics.chin,metrics.nose,metrics.eyes,metrics.skin].map(x=>Math.round(x*100));
      if(radarChart) radarChart.data.datasets[0].data = data, radarChart.update();
      else{
        radarChart = new Chart(document.getElementById('radar'),{
          type:'radar',data:{labels:labels,datasets:[{label:'مقاييس',data:data,fill:true}]},options:{plugins:{legend:{display:false}},scales:{r:{beginAtZero:true,max:100,ticks:{display:false}}}}
        });
      }

      // recommendations (simple rules)
      const recs = [];
      if(metrics.jaw < 0.55) recs.push('اخد بالك من وضعية الرقبة واشتغل تمارين رقبة ومقاومة 3x/أسبوع لزيادة تعريف الفك.');
      if(metrics.chin < 0.5) recs.push('العمل على تخفيف نسبة الدهون العامة (دايت + كارديو) يظهر الذقن أوضح.');
      if(metrics.skin < 0.6) recs.push('ابدأ روتين بشرة: غسول خفيف مرتين يوميًا + مرطب + واقي شمس.');
      if(metrics.symmetry < 0.6) recs.push('جرب تحسين زوايا التصوير واسمترال القصات الشعرية؛ في بعض حالات الخلل تحتاج تقييم طبيي.');
      if(recs.length===0) recs.push('شكل عام: كويس! حافظ على روتين بشرة وتمرن بانتظام.');

      document.getElementById('recs').innerHTML = recs.map(r => '<div style="margin-bottom:6px">• '+r+'</div>').join('');

      // store history locally
      const history = JSON.parse(localStorage.getItem('fa_history')||'[]');
      history.unshift({date:new Date().toLocaleString(),score:Math.round(sc*100)/100,metrics:data});
      localStorage.setItem('fa_history',JSON.stringify(history.slice(0,12)));
      renderHistory();
    }

    function renderHistory(){
      const h = JSON.parse(localStorage.getItem('fa_history')||'[]');
      const div = document.getElementById('history');
      div.innerHTML = h.map(it => `<div style="padding:8px;background:#070708;border-radius:8px;margin-bottom:6px">${it.date} — <b>${it.score}/1</b></div>`).join('')||'<div style="color:var(--muted)">لا يوجد سجلات</div>';
    }

    // draw landmarks
    let lastImageData = null;
    function onResults(results){
      lastResults = results;
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if(results.multiFaceLandmarks && results.multiFaceLandmarks.length>0){
        const landmarks = results.multiFaceLandmarks[0];
        // draw
        window.drawConnectors(ctx,landmarks,window.FACEMESH_TESSELATION,{color:'#888',lineWidth:0.8});
        window.drawLandmarks(ctx,landmarks,{color:'#fff',lineWidth:0.5,radius:1});

        // copy current video frame to overlay for skin sampling
        try{
          ctx.drawImage(video,0,0,overlay.width,overlay.height);
          lastImageData = ctx.getImageData(0,0,overlay.width,overlay.height);
        }catch(e){/*ignore*/}

        // compute metrics (landmarks are normalized coords)
        const m = computeMetrics(landmarks);
        updateUI(m);
      }
    }

    // setup MediaPipe FaceMesh
    const faceMesh = new window.FaceMesh({locateFile:(file)=>{
      return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});
    faceMesh.setOptions({maxNumFaces:1,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
    faceMesh.onResults(onResults);

    startCam.addEventListener('click',async ()=>{
      if(camera) return;
      const stream = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480},audio:false});
      video.srcObject = stream;
      await video.play();
      overlay.width = video.videoWidth/2; overlay.height = video.videoHeight/2;
      camera = new Camera(video,{onFrame:async ()=>{await faceMesh.send({image:video});},width:640,height:480});
      camera.start();
    });

    stopCam.addEventListener('click',()=>{
      if(!camera) return;
      camera.stop();
      const s = video.srcObject; if(s){s.getTracks().forEach(t=>t.stop());}
      video.srcObject = null; camera = null;
    });

    uploadInput.addEventListener('change',async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const img = new Image();
      img.onload = async ()=>{
        overlay.width = img.width; overlay.height = img.height;
        // draw image and run one-time analysis
        ctx.clearRect(0,0,overlay.width,overlay.height);
        ctx.drawImage(img,0,0,overlay.width,overlay.height);
        await faceMesh.send({image:img});
      };
      img.src = URL.createObjectURL(f);
    });

    analyzeBtn.addEventListener('click',async ()=>{
      // if have lastResults, re-run UI (already updated by onResults)
      if(lastResults && lastResults.multiFaceLandmarks && lastResults.multiFaceLandmarks.length>0){
        const m = computeMetrics(lastResults.multiFaceLandmarks[0]);
        updateUI(m);
      } else {
        alert('محتاج صورة وجه واضحة — شغل الكاميرا أو ارفع صورة frontal');
      }
    });

    renderHistory();
  </script>
</body>
</html>
